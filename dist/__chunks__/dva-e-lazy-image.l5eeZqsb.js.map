{"version":3,"file":"dva-e-lazy-image.l5eeZqsb.js","sources":["../../src/components/dva-e-lazy-image/dva-e-lazy-image.ts"],"sourcesContent":["import { Component, MQBasedRendered, uiEvent } from \"@kluntje/core\";\nimport { ViewportObserver, IN_VP_EVENT, LazyConnectService } from \"@kluntje/services\";\nimport { LOADING, LOADED, INITIALIZED, IN_VIEWPORT, HIDDEN, ERROR } from \"Constants/cssClasses\";\nimport { removeClass, addClass, onEvent, removeEvent, toggleClass } from \"@kluntje/js-utils/lib/dom-helpers\";\nimport { render } from \"lit-html\";\nimport mqDefinitions from \"Config/mediaQueries\";\nimport { getSrcset } from \"Utils/getSrcset\";\n\nimport { lazyImageTemplate } from \"./dva-e-lazy-image.template\";\n\nexport type ImageInitType = \"lazy\" | \"explicit\";\n\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\n@MQBasedRendered(mqDefinitions)\nexport class DVALazyImage extends Component {\n  viewportObserver = ViewportObserver.getInstance();\n\n  _hasError = false;\n  _loadingPlaceholderLoaded = false;\n  _loadingPlaceholderLoadingError = false;\n\n  constructor() {\n    super({\n      ui: {\n        image: \".dva-js-lazy-image__img :-one\",\n        placeholder: \".dva-e-lazy-image__img--placeholder :-one\",\n        wrapper: \".dva-js-lazy-image__wrapper :-one\",\n      },\n      initialStates: {\n        imgLoaded: false,\n      },\n      useShadowDOM: true,\n    });\n  }\n\n  connectedCallback() {\n    if (this.initType === \"lazy\") {\n      LazyConnectService.subscribe(this, () => super.connectedCallback());\n    } else {\n      super.connectedCallback();\n    }\n  }\n\n  get DEFAULT_FALLBACK_IMAGE(): string {\n    return \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 9'%3E%3C/svg%3E\";\n  }\n\n  get fallbackImg(): string {\n    return this.getAttribute(\"fallback-image\") || this.DEFAULT_FALLBACK_IMAGE;\n  }\n\n  /**\n   * Returns value of 'src'-Attribute\n   * @returns {string}\n   */\n  get imgSrc(): string {\n    return this.getAttribute(\"src\") || \"\";\n  }\n\n  /**\n   * Returns value of 'srcset'-Attribute\n   * @returns {string}\n   */\n  get imgSrcSet(): string {\n    return this.getAttribute(\"srcset\") || this.getSrcsetFromSrc();\n  }\n\n  /**\n   * Returns value of 'sizes'-Attribute\n   * @returns {string}\n   */\n  get imgSizes(): string {\n    return this.getAttribute(\"sizes\") || \"\";\n  }\n\n  /**\n   * Returns value of 'alt'-Attribute\n   * @returns {string}\n   */\n  get imgAlt(): string {\n    return this.getAttribute(\"alt\") || \"\";\n  }\n\n  /**\n   * Returns value of 'aspect-ratio'-Attribute\n   * @returns {string}\n   */\n  get imgAspectRatio(): string | null {\n    return this.getAttribute(\"aspect-ratio\");\n  }\n\n  /**\n   * Returns value of 'wrapper'-Attribute\n   * @returns {string}\n   */\n  get imgWrapper(): string {\n    return this.getAttribute(\"wrapper\") || \"\";\n  }\n\n  get noPlaceholder(): boolean {\n    return this.hasAttribute(\"no-placeholder\") && this.getAttribute(\"no-placeholder\") !== \"false\";\n  }\n\n  /**\n   * Returns, whether loaded image is Wider than needed\n   * @returns {boolean}\n   */\n  get hasOverWidth(): boolean {\n    return this.ui.image.offsetHeight < this.offsetHeight;\n  }\n\n  get hasError(): boolean {\n    return this._hasError;\n  }\n\n  set hasError(newErrorState: boolean) {\n    if (this.hasError === newErrorState) return;\n    this._hasError = newErrorState;\n    this.updateComponent();\n    toggleClass(this.ui.wrapper, ERROR, newErrorState);\n  }\n\n  get hasLoadingPlaceholder(): boolean {\n    return this.loadingPlaceholder !== \"\";\n  }\n\n  get loadingPlaceholderLoaded(): boolean {\n    return !this.hasLoadingPlaceholder || this._loadingPlaceholderLoaded;\n  }\n\n  set loadingPlaceholderLoaded(newLoadedState: boolean) {\n    if (this.loadingPlaceholderLoaded === newLoadedState) return;\n    this._loadingPlaceholderLoaded = newLoadedState;\n  }\n\n  get loadingPlaceholderLoadingError(): boolean {\n    return !this.hasLoadingPlaceholder || this._loadingPlaceholderLoadingError;\n  }\n\n  set loadingPlaceholderLoadingError(newErrorState: boolean) {\n    if (this.loadingPlaceholderLoadingError === newErrorState) return;\n    this._loadingPlaceholderLoadingError = newErrorState;\n    this.updateComponent();\n  }\n\n  /**\n   * Webcomponents Helper to observe Attribute Changes\n   * @override\n   * @returns {string[]}\n   */\n  static get observedAttributes(): string[] {\n    return [\"src\", \"srcset\", \"aspect-ratio\"];\n  }\n\n  /**\n   * Returns given init-type, default to lazy\n   * @returns {ImageInitType}\n   */\n  get initType(): ImageInitType {\n    switch (this.getAttribute(\"init\")) {\n      case \"explicit\":\n        return \"explicit\";\n      default:\n        return \"lazy\";\n    }\n  }\n\n  get fetchPriority(): string | null {\n    return this.getAttribute(\"fetchpriority\");\n  }\n\n  get loading(): string | null {\n    return this.getAttribute(\"loading\");\n  }\n\n  getLoadingPlaceholderFromSrc(): string {\n    const imgSrcUrl = new URL(this.imgSrc);\n    const width = imgSrcUrl.searchParams.get(\"width\");\n    if (width) {\n      imgSrcUrl.searchParams.set(\"width\", \"60\");\n      return imgSrcUrl.href;\n    }\n    return this.imgSrc;\n  }\n\n  getSrcsetFromSrc(): string {\n    const imgSrcUrl = new URL(this.imgSrc);\n    const width = imgSrcUrl.searchParams.get(\"width\");\n    if (width) {\n      return getSrcset(imgSrcUrl.href, [480, 760, 1024, 1280, 1440, 1460, 2000]);\n    }\n    return \"\";\n  }\n\n  get loadingPlaceholder(): string {\n    return this.getAttribute(\"loading-placeholder\") || this.getLoadingPlaceholderFromSrc();\n  }\n\n  /**\n   * Handles change of observed Attributes\n   * @override\n   * @param {string} name - name of Attribute, that changed\n   * @param {string} oldValue\n   * @param {string} newValue\n   */\n  attributeChangedCallback(name: string, oldValue: string, newValue: string): void {\n    if (oldValue === newValue || !this.state.initialized) return;\n\n    switch (name) {\n      case \"src\":\n        this.setState({ imgLoaded: false });\n        this.loadImage();\n        break;\n      case \"srcset\":\n        this.setState({ imgLoaded: false });\n        this.loadImage();\n        break;\n      case \"aspect-ratio\":\n        this.renderComponent();\n        this.handleOverwidth();\n        break;\n    }\n  }\n\n  /**\n   * Renders Component via lit-html\n   */\n  renderComponent(): void {\n    render(\n      lazyImageTemplate({\n        alt: this.imgAlt,\n        srcset: \"\",\n        sizes: this.imgSizes,\n        component: this,\n        wrapper: this.imgWrapper,\n      }),\n      this.getUiRoot(),\n    );\n  }\n\n  /**\n   * Rerenders Component via lit-html\n   */\n  updateComponent(): void {\n    render(\n      lazyImageTemplate({\n        alt: this.imgAlt,\n        srcset: this.imgSrcSet,\n        sizes: this.imgSizes,\n        component: this,\n      }),\n      this.getUiRoot(),\n    );\n  }\n\n  /**\n   * Lifecycle-Hook: Initializes Component after render\n   * @override\n   */\n  afterComponentRender(): void {\n    addClass(this, INITIALIZED);\n    removeClass(this.ui.wrapper, HIDDEN);\n    if (this.initType !== \"explicit\") this.viewportObserver.observe(this);\n    if (this.initType === \"explicit\") this.loadImage();\n  }\n\n  /**\n   * Lifecycle-Hook for removing markup on destroy\n   */\n  beforeComponentDisconnects(): void {\n    addClass(this.ui.wrapper, HIDDEN);\n  }\n\n  /**\n   * Lifecycle-Hook for removing markup on destroy\n   */\n  destroyComponent(): void {\n    this.setState({ imgLoaded: false });\n  }\n\n  /**\n   * Initiates Image Load, by add src(-set) to img in shadow-DOM\n   */\n  @uiEvent(\"this\", IN_VP_EVENT)\n  loadImage(): void {\n    this.viewportObserver.unobserve(this);\n    if (this.state.imgLoaded) return;\n    addClass(this, IN_VIEWPORT);\n    addClass(this.ui.wrapper, LOADING);\n    const currentImage = this.ui.image;\n    this.attachImageEvents(currentImage); // attach loading events\n    // trigger image loading\n    if (this.imgSrc || this.imgSrcSet) {\n      if (this.imgSrc) currentImage.setAttribute(\"src\", this.imgSrc);\n      if (this.imgSrcSet) currentImage.setAttribute(\"srcset\", this.imgSrcSet);\n    } else {\n      console.warn(\"LazyImage: no src/srcset provided for\", currentImage);\n    }\n  }\n\n  /**\n   * Handles any ImageLoading-Errors\n   */\n  handleImageLoadingError(): void {\n    const currentImg = this.ui.image;\n\n    removeEvent(currentImg, \"error\", this.handleImageLoadingError, this);\n    // currentImg.setAttribute(\"src\", this.fallbackImg);\n    // currentImg.setAttribute(\"srcset\", \"\");\n    this.hasError = true;\n    this.dispatchEvent(\n      new CustomEvent(\"dva-image-error\", {\n        detail: {\n          target: this,\n        },\n      }),\n    );\n    console.log(\"lazyImg error:\", currentImg);\n  }\n\n  /**\n   * Handles ImageLoad-Event, by setting/removing needed Classes\n   */\n  handleImageLoad(): void {\n    this.handleOverwidth();\n\n    this.hasError = false;\n    removeEvent(this.ui.image, \"load\", this.handleImageLoad, this);\n    removeClass(this.ui.wrapper, LOADING);\n    addClass(this, LOADED);\n    addClass(this.ui.image, LOADED);\n    addClass(this.ui.placeholder, HIDDEN);\n\n    this.dispatchEvent(\n      new CustomEvent(\"dva-image-loaded\", {\n        detail: {\n          target: this,\n        },\n      }),\n    );\n    this.setState({ imgLoaded: true });\n  }\n\n  /**\n   * Adds needed Events for ImageLoading\n   * @param {Node} img - image in Shadow-DOM\n   */\n  attachImageEvents(img: HTMLImageElement): void {\n    onEvent(img, \"load\", this.handleImageLoad, this);\n    onEvent(img, \"error\", this.handleImageLoadingError, this);\n  }\n\n  /**\n   * Checks if image has Overwidth and optinally adds needed class\n   */\n  handleOverwidth(): void {\n    removeClass(this.ui.wrapper, \"dva-e-lazy-image__wrapper--has-overwidth\");\n    if (this.hasOverWidth) {\n      addClass(this.ui.wrapper, \"dva-e-lazy-image__wrapper--has-overwidth\");\n    }\n  }\n}\n\ncustomElements.define(\"dva-e-lazy-image\", DVALazyImage);\n"],"names":["DVALazyImage","Component","ViewportObserver","LazyConnectService","newErrorState","toggleClass","ERROR","newLoadedState","imgSrcUrl","getSrcset","name","oldValue","newValue","render","lazyImageTemplate","addClass","INITIALIZED","removeClass","HIDDEN","IN_VIEWPORT","LOADING","currentImage","currentImg","removeEvent","LOADED","img","onEvent","__decorateClass","uiEvent","IN_VP_EVENT","MQBasedRendered","mqDefinitions"],"mappings":"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"}